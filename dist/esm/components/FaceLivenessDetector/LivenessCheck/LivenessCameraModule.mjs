import e,{useRef as t,useState as r}from"react";import a from"classnames";import{Loader as s,Flex as o,View as i}from"@aws-amplify/ui-react";import"../service/machine/index.mjs";import{FaceMatchState as c}from"../service/types/liveness.mjs";import"../service/types/error.mjs";import"tslib";import"@tensorflow/tfjs-core";import"@tensorflow-models/blazeface";import"@tensorflow/tfjs-backend-wasm";import"@tensorflow/tfjs-backend-cpu";import"@aws-amplify/core";import"../service/utils/liveness.mjs";import"../service/utils/streamProvider.mjs";import"../service/utils/freshnessColorDisplay.mjs";import{useLivenessActor as m}from"../hooks/useLivenessActor.mjs";import{useLivenessSelector as n,createLivenessSelector as l}from"../hooks/useLivenessSelector.mjs";import{useMediaStreamInVideo as d}from"../hooks/useMediaStreamInVideo.mjs";import{CancelButton as h}from"../shared/CancelButton.mjs";import{selectErrorState as p,Hint as v}from"../shared/Hint.mjs";import{MatchIndicator as f}from"../shared/MatchIndicator.mjs";import{Overlay as u}from"../shared/Overlay.mjs";import{RecordingIcon as E}from"../shared/RecordingIcon.mjs";import{LivenessClassNames as y}from"../types/classNames.mjs";import{renderErrorModal as C,FaceLivenessErrorModal as j}from"../shared/FaceLivenessErrorModal.mjs";const g=l((e=>{var t;return null===(t=e.context.videoAssociatedParams)||void 0===t?void 0:t.videoMediaStream})),M=l((e=>e.context.faceMatchAssociatedParams.faceMatchPercentage)),N=l((e=>e.context.faceMatchAssociatedParams.faceMatchState)),A=e.createElement(s,{size:"large",className:y.Loader,"data-testid":"centered-loader"}),I=e.memo(f),T=s=>{const{isMobileScreen:l,isRecordingStopped:f,streamDisplayText:T,hintDisplayText:D,errorDisplayText:w,components:x,testId:b}=s,{cancelLivenessCheckText:S,recordingIndicatorText:L}=T,{ErrorView:O=j}=null!=x?x:{},[k,F]=m(),R=n(g),P=n(M),_=n(N),H=n(p),V=[c.TOO_FAR,c.CANT_IDENTIFY,c.FACE_IDENTIFIED,c.MATCHED],{videoRef:z,videoWidth:W,videoHeight:$}=d(R),B=t(null),X=t(null),[Y,q]=r(!1),G=k.matches("cameraCheck"),J=k.matches("recording"),K=k.matches("checkSucceeded"),Q=k.matches({recording:"flashFreshnessColors"}),[U,Z]=r(W),[ee,te]=r($),[re,ae]=r((()=>W&&$?W/$:0));e.useLayoutEffect((()=>{Y&&F({type:"SET_DOM_AND_CAMERA_DETAILS",data:{videoEl:z.current,canvasEl:B.current,freshnessColorEl:X.current,isMobile:l}}),z.current&&(Z(z.current.videoWidth),te(z.current.videoHeight),ae(z.current.videoWidth/z.current.videoHeight))}),[F,z,Y,l]);return G?e.createElement(o,{height:$,width:"100%",position:"relative"},A):e.createElement(o,{className:a(y.CameraModule,l&&`${y.CameraModule}--mobile`),"data-testid":b},!Y&&A,e.createElement(i,{as:"canvas",ref:X,className:y.FreshnessCanvas,hidden:!0}),e.createElement(i,{className:y.VideoAnchor,style:{aspectRatio:`${re}`}},e.createElement("video",{ref:z,muted:!0,autoPlay:!0,playsInline:!0,style:{transform:"scaleX(-1)"},width:U,height:ee,onCanPlay:()=>{q(!0)},"data-testid":"video",className:y.Video}),e.createElement(o,{className:a(y.OvalCanvas,l&&`${y.OvalCanvas}--mobile`,f&&y.FadeOut)},e.createElement(i,{as:"canvas",width:"100%",height:"100%",ref:B})),J&&e.createElement(i,{className:y.RecordingIconContainer},e.createElement(E,null,L)),!K&&e.createElement(i,{className:y.CancelContainer},e.createElement(h,{ariaLabel:S})),e.createElement(u,{anchorOrigin:{horizontal:"center",vertical:J&&!Q?"start":"space-between"},className:y.InstructionOverlay},e.createElement(v,{hintDisplayText:D}),H&&e.createElement(O,{onRetry:()=>{F({type:"CANCEL"})}},C({errorState:H,overrideErrorDisplayText:w})),J&&!Q&&V.includes(_)?e.createElement(I,{percentage:Math.ceil(P)}):null)))};export{T as LivenessCameraModule,M as selectFaceMatchPercentage,N as selectFaceMatchState,g as selectVideoStream};
