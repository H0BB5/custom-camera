import{__awaiter as t,__asyncGenerator as e,__await as o,__asyncValues as s}from"tslib";import{formatUrl as r}from"@aws-sdk/util-format-url";import{readableStreamtoIterable as n,iterableToReadableStream as i}from"@smithy/eventstream-serde-browser";import{FetchHttpHandler as c}from"@smithy/fetch-http-handler";import{HttpResponse as a}from"@smithy/protocol-http";import{WS_CLOSURE_CODE as l}from"./constants.mjs";const d=2e3,h=t=>{return t[Symbol.asyncIterator]?t:(s=t,"function"==typeof ReadableStream&&s instanceof ReadableStream?n(t):{[Symbol.asyncIterator]:function(){return e(this,arguments,(function*(){yield yield o(t)}))}});var s};class f{constructor(t,e=new c){this.metadata={handlerProtocol:"websocket/h1.1"},this.sockets={},this.utf8decoder=new TextDecoder,this.httpHandler=e,this.configPromise="function"==typeof t?t().then((t=>null!=t?t:{})):Promise.resolve(null!=t?t:{})}destroy(){for(const[t,e]of Object.entries(this.sockets)){for(const t of e)t.close(1e3,"Socket closed through destroy() call");delete this.sockets[t]}}handle(e){return t(this,void 0,void 0,(function*(){if(!(t=>"ws:"===t.protocol||"wss:"===t.protocol)(e))return this.httpHandler.handle(e);const t=r(e),o=new WebSocket(t);this.sockets[t]||(this.sockets[t]=[]),this.sockets[t].push(o),o.binaryType="arraybuffer";const{connectionTimeout:s=d}=yield this.configPromise;yield this.waitForReady(o,s);const{body:n}=e,c=h(n),l=(t=>"function"==typeof ReadableStream?i(t):t)(this.connect(o,c));return{response:new a({statusCode:200,body:l})}}))}removeNotUsableSockets(t){var e;this.sockets[t]=(null!==(e=this.sockets[t])&&void 0!==e?e:[]).filter((t=>![WebSocket.CLOSING,WebSocket.CLOSED].includes(t.readyState)))}waitForReady(t,e){return new Promise(((o,s)=>{const r=setTimeout((()=>{this.removeNotUsableSockets(t.url),s({$metadata:{httpStatusCode:500}})}),e);t.onopen=()=>{clearTimeout(r),o()}}))}connect(e,o){let r,n=!1,i=()=>{},c=()=>{};e.onmessage=t=>{c({done:!1,value:new Uint8Array(t.data)})},e.onerror=t=>{n=!0,e.close(),i(t)},e.onclose=()=>{this.removeNotUsableSockets(e.url),n||(r?i(r):c({done:!0,value:void 0}))};const a={[Symbol.asyncIterator]:()=>({next:()=>new Promise(((t,e)=>{c=t,i=e}))})};return(()=>{t(this,void 0,void 0,(function*(){var t,n,i,c;try{try{for(var a,d=!0,h=s(o);!(t=(a=yield h.next()).done);){c=a.value,d=!1;try{const t=c,o=this.utf8decoder.decode(t);if(o.includes("closeCode")){const t=o.match(/"closeCode":([0-9]*)/);if(t){const o=t[1];e.close(parseInt(o))}continue}e.send(t)}finally{d=!0}}}catch(t){n={error:t}}finally{try{d||t||!(i=h.return)||(yield i.call(h))}finally{if(n)throw n.error}}}catch(t){r=t}finally{e.close(l.SUCCESS_CODE)}}))})(),a}}export{f as CustomWebSocketFetchHandler};
